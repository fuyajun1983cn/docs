--- 
layout: default
---
<div class="header">
  <div class="jumbotron">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>WiFi案例集锦</h1>
          <p>WiFi问题处理经验记录。</p>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">WiFi案例集锦racast无法连接</h1>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">案例1 Miracast无法连接</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">问题描述</h3>
<div class="outline-text-3" id="text-1-1">
<p>
客户平台的网卡从一家厂商的芯片更换为另一家的芯片，结果出现WiFi
Miracast无法连接成功的情况。
</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">问题分析</h3>
<div class="outline-text-3" id="text-1-2">
<p>
初步信息调查：
</p>
<ol class="org-ol">
<li>客户平台内核版本为： 3.1.10
</li>
<li>实测发现，当平台作GC时，连接没有问题。
</li>
<li>分析手机端和平台端的 <code>wpa_supplicant.log</code> ，有如下一些发现：
<ul class="org-ul">
<li>平台端如下Log异常：
<img src="http://blog.ifjy.me/images/2016/2016031101.png" class="img-responsive" alt="2016031101.png">
Associaite Request中没有包含RSN IE等相关信息，这是P2P连接过程
中，所必须。
</li>
<li>手机端有如下Log异常：
<pre class="example">
 03-03 16:06:08.252 I/wpa_supplicant(  864): p2p0: WPS-M2D dev_password_id=0 config_error=12
 03-03 16:06:08.255 D/wpa_supplicant(  864): EAPOL: txSuppRsp
03-03 16:06:08.255 D/wpa_supplicant(  864): TX EAPOL: dst=06:3d:98:a6:29:34
03-03 16:06:08.255 D/wpa_supplicant(  864): TX EAPOL - hexdump(len=78): 01 00 00 4a 02 4d 00 4a fe 00 37 2a 00 00 00 01 02 00 10 4a 00 01 10 10 22 00 01 0d 10 1a 00 10 ...
03-03 16:06:08.256 D/wpa_supplicant(  864): EAPOL: SUPP_BE entering state RECEIVE
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: Terminate connection due to WPS PBC session overlap
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: Group Formation failed with 06:3d:98:a6:29:34
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: Clear timeout (state=PROVISIONING)
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: State PROVISIONING -&gt; IDLE
03-03 16:06:08.256 I/wpa_supplicant(  864): P2P-GROUP-FORMATION-FAILURE
</pre>
</li>
</ul>
<p>
<code>config_error</code>  的值为 12， 其意义为：　
<code>WPS_CFG_MULTIPLE_PBC_DETECTED</code> ，这个是GO在处理M1信息时，带上的。
</p>
</li>
<li>根据双方的Log， GO在处理GC发送过来的M1消息后，回复了M2D信息给GC，
从而中断了WPS的交互过程。从如下代码入手分析：


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031102.png" class="img-responsive" alt="2016031102.png">
</p>
</figure>

<p>
函数 <code>wps_registrar_p2p_dev_addr_match</code> 中进行地址过滤时，发现了
线索：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031103.png" class="img-responsive" alt="2016031103.png">
</p>
</figure>

<p>
正常情况下， <code>reg-&gt;p2p_dev_addr</code> 的值应该与 <code>wps-&gt;p2p_dev_addr</code>
的值一致，但是从出错Log中发现 <code>wps-&gt;p2p_dev_addr</code> 的值为0。  
而 wps 相关的初始化是在 <code>eap_wsc_init</code> 在调用了 <code>wps_init</code> 来进
行初始化的。  如下图所示 ：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031104.png" class="img-responsive" alt="2016031104.png">
</p>
</figure>

<p>
有个条件引起来我们的注意：
<code>sm-&gt;assoc_p2p_ie</code>  
是否因为这个为NULL，导致 <code>wps_init</code> 初始化时， <code>p2p_dev_addr</code>  没有
得到赋值？
</p>
</li>
<li>分析 <code>wpa_supplicant</code> 处理Associate Request的函数代码：
在函数 <code>hostapd_notif_assoc</code> 里面，会解析 Associate Request 携带
的IE信息， 代码如下：  


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031105.png" class="img-responsive" alt="2016031105.png">
</p>
</figure>

<p>
可以发现，并结合之前的Log发现， WPS， RSN， WPA等 IE信息都为空。
所以有理由 怀疑Driver送上来的Associate Request中就没有包含这些IE
信息， IE信息为空！！！
</p>
</li>
<li>Driver层确认
 在Driver处理Association Request的地方， 加一些打印Log确认收到的
IE是否为空，结果发现，Driver有收到这些IE信息的。 Driver在处理完
Associate Request后，如果OK，会送回一个Associate Response给对方
，并调用 <code>cfg80211_new_sta</code> 将Associate Request事件通知到上层。
应该在这个地方可能将IE信息漏掉了。 
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">解决方法</h3>
<div class="outline-text-3" id="text-1-3">
<p>
由于定位到问题的原因是：驱动在调用 <code>cfg80211_new_sta</code> 时，没有将 如
下标记设置：
</p>

<div class="org-src-container">

<pre class="src src-c">struct station_info sinfo;
struct ieee80211_mgmt *mgmt;

NdisZeroMemory(&amp;sinfo, sizeof(sinfo));

//因为这个标记没有置上，导致nl80211模块处理IE信息时，
//将assoc_req IE给过滤掉了, 正解就是要让这句执行。
 sinfo.filled = STATION_INFO_ASSOC_REQ_IES;

 mgmt = (struct ieee80211_mgmt *) assoc_frame;
 sinfo.assoc_req_ies_len = assoc_len - 24 - 4;
sinfo.assoc_req_ies = mgmt-&gt;u.assoc_req.variable;

return cfg80211_new_sta(pNetDev, mac_addr, &amp;sinfo, GFP_KERNEL);
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">案例2 p2p虚拟网络接口打开时，出现设备忙</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">问题描述</h3>
<div class="outline-text-3" id="text-2-1">
<p>
设备当GO时， p2p virtual interface 启动时，有时会出现Device or Resource is busy
</p>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">问题分析</h3>
<div class="outline-text-3" id="text-2-2">
<p>
p2p 协商成功后，会创建一个virtual interface, 即 调用
<code>wpa_driver_nl80211_if_add</code> ， 在该函数中，会调用
<code>linux_set_iface_flags</code> 将虚拟接口设置为UP状态， 查看该函数的代码如
下：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031106.png" class="img-responsive" alt="2016031106.png">
</p>
</figure>

<p>
在下这个命令时，出现上述错误。 kernel中处理该命令的函数为：
<code>devinet_ioctl</code>
进一步追下去，在该函数中： <code>__dev_change_flags</code> 有如下代码：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031107.png" class="img-responsive" alt="2016031107.png">
</p>
</figure>

<p>
UP会对应 <code>__dev_open</code> 函数。 这个函数会调用driver注册的打开网络接口
的回调函数。如下代码所示 ：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031108.png" class="img-responsive" alt="2016031108.png">
</p>
</figure>

<p>
从上述代码也可以看到，在打开设备之前，会发送一个 <code>NETDEV_PRE_UP</code> 通
知链消息。 在 <code>cfg80211_netdev_notifier_call</code> 函数中，会处理该消息：
这个逻辑主要是一些Sanity Check，即此时能不能打开该网络接口。
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031109.png" class="img-responsive" alt="2016031109.png">
</p>
</figure>

<p>
最重要的处理函数是 <code>cfg80211_can_use_iftype_chan</code> ，在这个函数中会
分析当前打开网络接口是否有问题。
</p>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">解决方法</h3>
<div class="outline-text-3" id="text-2-3">
<p>
通过对上述代码的分析，结合driver的Log，做出了如下的修改：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031110.png" class="img-responsive" alt="2016031110.png">
</p>
</figure>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">案例3 在某个特定区域WiFi性能很差</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">问题描述</h3>
<div class="outline-text-3" id="text-3-1">
<p>
客户报怨仓库某个指定的区域WiFi性能很差，WiFi速率很慢。如下是抓包过程
中，某个数据帧的情况：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031401.png" class="img-responsive" alt="2016031401.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">问题分析</h3>
<div class="outline-text-3" id="text-3-2">
<p>
从上述抓包的信息来看，有两个信息值得注意：
</p>
<ol class="org-ol">
<li>信号干扰
</li>
<li>重传
</li>
</ol>
<p>
上述数据包是一个重传的数据包。 在Channel 6上重传概率大于30%。 
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031402.png" class="img-responsive" alt="2016031402.png">
</p>
</figure>

<p>
从WiSpy工具查看信号干扰情况，发现Channel 1～6 干扰很严重。
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031403.png" class="img-responsive" alt="2016031403.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">解决方法</h3>
<div class="outline-text-3" id="text-3-3">
<p>
有发现周围有一个老旧的摄像机在周围，然而没有使用，但是通电着。这个摄
像机对Channel 1～6之间的信号干扰很大，导致出现较高的数据重传率。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">案例4 固件升级后，手机出现奇怪现象</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">问题描述</h3>
<div class="outline-text-3" id="text-4-1">
<p>
固件升级后，一些手机出现奇怪的现象。 它们会连接到网络，然后断开并显
示定位网络服务的信息。这个过程是可重复的。
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">问题分析</h3>
<div class="outline-text-3" id="text-4-2">
<p>
数据包抓取结果如下：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031404.png" class="img-responsive" alt="2016031404.png">
</p>
</figure>

<p>
如上图红色标记，Duration的值太大，有点异常，一般情况下，应该只有几十
毫秒。
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">解决方法</h3>
<div class="outline-text-3" id="text-4-3">
<p>
这个问题最后查出是手机Firmware代码的Bug，导致在处理与802.11n的AP交互时，
出现Duration值异常的情况。这会影响周围所有的WiFi设备，而不仅仅是这个
手机。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">案例5 WiFi性能差，且有时连接不上WiFi网络</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">问题描述</h3>
<div class="outline-text-3" id="text-5-1">
<p>
客户抱怨WiFi网络性能差，且有时甚至连接不上WiFi网络。
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">问题分析</h3>
<div class="outline-text-3" id="text-5-2">
<p>
抓包信息如下：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031405.png" class="img-responsive" alt="2016031405.png">
</p>
</figure>

<p>
可以看到出现了CRC错误， 这表明我的抓包工具不能正确地读取帧信息。当靠
近发送数据的设备时，CRC错误率会降低。 
</p>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">问题解决</h3>
<div class="outline-text-3" id="text-5-3">
<p>
当通信双方的距离大于一定值后，会出现CRC错误率变高的情况，尝试靠近一
下，看CRC错误率是否会降低。 
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">案例6 客户报怨传输高分辨率的图片时很慢</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">问题描述</h3>
<div class="outline-text-3" id="text-6-1">
<p>
客户报怨他们新的网卡传输高分辨率的图片时，速率非常慢。然而，在上星期
的售前演示时，却没有这样的问题。
</p>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2">问题分析</h3>
<div class="outline-text-3" id="text-6-2">
<p>
抓取数据包如下：
</p>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016031406.png" class="img-responsive" alt="2016031406.png">
</p>
</figure>

<p>
发现上述情况不断重复，即不停地进行Off-Channel扫描，然而网卡没有动，
且非常靠近AP。 
</p>

<p>
<code>一个设备在off-channel或休眠状态下是不会传输数据的。</code> NULL数据帧使用
power management位来通知AP为其缓存数据帧。 通常有如下两种原因：
</p>
<ol class="org-ol">
<li>节省电力
</li>
<li>执行off-channel扫描来建立一个neighbor列表,以方便未来可能进行的漫
游动作。
</li>
</ol>

<p>
在这个案例中，STA不停地尝试建立一个neighbor列表，可以看到它在正执行
off-channel扫描（在信息1,6,11之间不停地切换）。这表明STA正在尝试寻找
一个更好的AP去关联，有如下可能的原因会导致这种行为发生：
</p>
<ol class="org-ol">
<li>driver有错误。
</li>
<li>STA错误地配置了高概率的漫游。
</li>
<li>RF差，没有接收到数据。
</li>
<li>天线坏了或者是没有接好。
</li>
<li>干涉。
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3">解决方法</h3>
<div class="outline-text-3" id="text-6-3">
<p>
基于上述的分析以及可能的原因，发现USB接口的网卡插在显示器的背部，周
围几乎被金属包围。这样会导致USB性能很差，很能保持连接，会导致不停地
漫游到新的AP上。
<img src="http://blog.ifjy.me/images/2016/2016031401.jpg" class="img-responsive" alt="2016031401.jpg">
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">案例7 连接老旧AP热点失败</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">问题描述</h3>
<div class="outline-text-3" id="text-7-1">
<p>
连接一台比较旧的AP时，连接失败，被AP拒绝。对比其他平台，可以正常连接。
</p>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">问题分析</h3>
<div class="outline-text-3" id="text-7-2">
<p>
这个问题看上去应该是AP兼容性问题，需要一份正常连接的Log和失败的Log进
行对比，以判断问题点。
</p>

<ol class="org-ol">
<li>首先看AP回的Probe Response的信息


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016051301.png" class="img-responsive" alt="2016051301.png">
</p>
</figure>

<p>
从图中，可以看到几个信息：
</p>
<ul class="org-ul">
<li>此AP不包含HT Capability，说明是不支持11n的（注：在解决问题前，
是不清楚AP是很老旧的AP这个信息的。）
</li>

<li>第二，就是AP的一些Capability信息。
</li>
</ul>
</li>

<li>其次看下连接失败时，发送给AP的Association Request的包的信息


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016051302.png" class="img-responsive" alt="2016051302.png">
</p>
</figure>
</li>

<li>其他平台能正常连接到此AP时，发送给AP的Associaiton Request的包的信
息


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016051303.png" class="img-responsive" alt="2016051303.png">
</p>
</figure>
</li>
</ol>


<p>
通过对比，可以发现有如下两个疑点：
</p>
<ol class="org-ol">
<li>Association Request中的immediate Bloack Ack Allowed这个位没有设置。
</li>
<li>在发送给AP的Association Request中的信息中包含有Extended
Capabilities信息。
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">解决方法</h3>
<div class="outline-text-3" id="text-7-3">
<p>
针对上述两个疑点，发现连接不上的主要原因是在Association Request中携
带了Extended Capabilities IE信息。针对这种情况， <code>wpa_supplicant</code> 已
经有了一个修改的思路：
</p>

<div class="org-src-container">

<pre class="src src-c">/*
 * Workaround: Add Extended Capabilities element only if the AP
 * included this element in Beacon/Probe Response frames. Some older
 * APs seem to have interoperability issues if this element is
 * included, so while the standard may require us to include the
 * element in all cases, it is justifiable to skip it to avoid
 * interoperability issues.
 */
if (!bss || wpa_bss_get_ie(bss, WLAN_EID_EXT_CAPAB)) {
        u8 ext_capab[18];
        int ext_capab_len;
        ext_capab_len = wpas_build_ext_capab(wpa_s, ext_capab,
                                             sizeof(ext_capab));
        if (ext_capab_len &gt; 0) {
                u8 *pos = wpa_ie;
                if (wpa_ie_len &gt; 0 &amp;&amp; pos[0] == WLAN_EID_RSN)
                        pos += 2 + pos[1];
                os_memmove(pos + ext_capab_len, pos,
                           wpa_ie_len - (pos - wpa_ie));
                wpa_ie_len += ext_capab_len;
                os_memcpy(pos, ext_capab, ext_capab_len);
        }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">案例8 A模下吞吐量偏低的问题</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">问题描述</h3>
<div class="outline-text-3" id="text-8-1">
<p>
客户 有报在A模下吞吐量偏低的问题，
 标准要求在20MBit/s, 但是测试到的结果低于10Mbit/s.
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">问题分析</h3>
<div class="outline-text-3" id="text-8-2">
<p>
当在A模式下，设置AP在某些channel, driver会识别成其他的
Channel，这时吞吐量会偏低。
</p>

<p>
在Side Band Channel听到比较弱的AP Beacon
</p>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3">解决方法</h3>
<div class="outline-text-3" id="text-8-3">
<p>
过滤到非Ajacent信道上侦听到的Beacon。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">案例9 p2p go失败后，导致wlan断开</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">问题描述</h3>
<div class="outline-text-3" id="text-9-1">
<p>
When we are doing concurrent p2p connection (STA + P2P-GO) using
dynamic interface, after some trails the GO-NEG fails which is
causing the STA connection to be deauthenticated.
</p>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">问题分析</h3>
<div class="outline-text-3" id="text-9-2">
<ol class="org-ol">
<li><code>NEG_FAIL</code> 失败的原因
the reason for failing the <code>add_iface</code> is because we have exceeded
the maximum number of VIF's. So we are ok with p2p GO-NEG
failing, but the problem is it disconnects the STA interface.
</li>
<li>问题初步分析
<ul class="org-ul">
<li>It looks like some of the calls in at least one of the error
paths end up getting going through both p2p-wlan0-# and
wlan0 interface when handling this type of failure case. The
pending p2p-wlan0-# instance gets removed properly, but
wlan0 instance should not have tried to remove the pending
P2P group since it was not on that instance in the first
place.
</li>
<li>The reason for GO-NEG fail is that "<code>add_iface</code>" is failing, so
"<code>p2p_group_interface</code>" is not set, but in <code>wpas_p2p_group_delete</code>
based on the below condition we are deleting the STA managed
interface.
<code>wpas_p2p_group_delete()</code> should not be called on the non-P2P
station interface.
<div class="org-src-container">

<pre class="src src-c">else if (wpa_s-&gt;p2p_group_interface == P2P_GROUP_INTERFACE_CLIENT ||
                  (ssid &amp;&amp; ssid-&gt;mode == WPAS_MODE_INFRA)) {
                 wpa_s-&gt;reassociate = 0;
                 wpa_s-&gt;disconnected = 1;
                 gtype = "client";
</pre>
</div>

<p>
Is there any reason for checking INFRA mode in p2p module?
Yes, <code>WPAS_MODE_INFRA</code> is used for P2P Client as well as
non-P2P station.
</p>
</li>
</ul>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">解决方案</h3>
<div class="outline-text-3" id="text-9-3">
<p>
It was possible for a P2P group formation failure to result in a
concurrent station mode operation getting disconnected in the
specific error case where group interface addition fails after a
successful GO Negotiation. Fix this by skipping the
<code>wpas_p2p_group_delete()</code> call in this specific case since the group
interface does not exists anymore at the point
<code>wpas_group_formation_completed()</code> gets called.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">案例10 Miracast过程中，视频卡住</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1">问题描述</h3>
<div class="outline-text-3" id="text-10-1">
<p>
当TV与RealTek的测试设备进行Miracast连接时，Miracast播放视频卡住。
</p>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2">问题分析</h3>
<div class="outline-text-3" id="text-10-2">
</div><div id="outline-container-sec-10-2-1" class="outline-4">
<h4 id="sec-10-2-1">现象梳理</h4>
<div class="outline-text-4" id="text-10-2-1">
<ol class="org-ol">
<li>P2P established successfully
p2p连接成功
</li>
<li>Data Transmission over p2p is ok
相互之间是可以Ping通的
</li>
<li>从Video播放的日志来看， Video frame rate应该为30fps，但是实际
10fps都不到，且A/V一直在Drop Frame，这表明从Driver端收到的数据
不够快。
</li>
<li>这个问题只在2.4G的情况下出现 ，5G情况下不会出现。
</li>
<li>对比测试有如下现象：
<ul class="org-ul">
<li>Dut run on 5GHz: Pass
</li>
<li>Dut act as GO: Pass
</li>
<li>Dut act as GC: Fail
</li>
</ul>
<p>
怀疑管理帧有带错东西导致送数据的速率很低。
 这个是Probe Request相关信息：
  <img src="http://blog.ifjy.me/images/2016/2016072001.png" class="img-responsive" alt="2016072001.png">
</p>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-10-2-2" class="outline-4">
<h4 id="sec-10-2-2">问题根源</h4>
<div class="outline-text-4" id="text-10-2-2">
<ol class="org-ol">
<li>Realtek testbed transmit data frame using 40MHz in 2.4G (check with sniffer)
</li>
<li>DUT is forced 20MHz Bandwidth in 2.4G
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3">问题解决</h3>
<div class="outline-text-3" id="text-10-3">
<p>
在GC与GO关联的过程中，在Association  Request显示设置 HtCapability
IE ，根据情况，将ChannelWidth设置为20MHz
</p>
<div class="org-src-container">

<pre class="src src-c">static VOID ApCliMlmeAssocReqAction(IN PRTMP_ADAPTER pAd, IN MLME_QUEUE_ELEM * Elem)
{
…..
#ifdef CUSTOMIZED_BW_SETTING
                        if (RTMP_GetCustomizedChannelBw(pAd,
                                apcli_entry-&gt;wdev.channel) == HT_BW_20) {
                                HtCapabilityTmp.HtCapInfo.ChannelWidth = BW_20;
                        }
#endif /* CUSTOMIZED_BW_SETTING */
...
  }
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">案例11 TCP RX enhancement</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1">问题描述</h3>
<div class="outline-text-3" id="text-11-1">
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="right">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-left">&#xa0;</th>
<th scope="col" class="text-left">XXX</th>
<th scope="col" class="text-right">BCM43569</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-left">TCP RX</td>
<td class="text-left"><code>Avg 220 Peek 250</code></td>
<td class="text-right">257</td>
</tr>

<tr>
<td class="text-left">UDP RX</td>
<td class="text-left">Avg 285 Peek 299</td>
<td class="text-right">280</td>
</tr>
</tbody>
</table>

<p>
与对比平台相比，TCP吞吐量罗低。
</p>
</div>
</div>
<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2">问题分析</h3>
<div class="outline-text-3" id="text-11-2">
<p>
在跟TCP RX时，出现很多Bulkout Pending， 如下图所示：
<img src="http://blog.ifjy.me/images/2016/2016080302.png" class="img-responsive" alt="2016080302.png">
怀疑可能是因为TCP ack TX过慢（波动较大）
</p>
</div>
</div>
<div id="outline-container-sec-11-3" class="outline-3">
<h3 id="sec-11-3">问题解决</h3>
<div class="outline-text-3" id="text-11-3">
<p>
针对TCP ack包，提高它的优先级.
<img src="http://blog.ifjy.me/images/2016/2016080303.png" class="img-responsive" alt="2016080303.png">
</p>
</div>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">案例12 hostapd启动时报错: nl80211: set<sub>key</sub> failed</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1">问题描述</h3>
<div class="outline-text-3" id="text-12-1">
<p>
在启动hostapd时，失败，有如下Log出现：
</p>
<pre class="example">
D/hostapd ( 2058): random: Got 5/20 bytes from /dev/random
I/hostapd ( 2058): random: Only 5/20 bytes of strong random data available from /dev/random
I/hostapd ( 2058): random: Not enough entropy pool available for secure operations
I/hostapd ( 2058): WPA: Not enough entropy in random pool for secure operations - update keys later when the first station connects
D/hostapd ( 2058): GMK - hexdump(len=32): [REMOVED]
D/hostapd ( 2058): Key Counter - hexdump(len=32): [REMOVED]
D/hostapd ( 2058): WPA: Delay group state machine start until Beacon frames have been configured
D/hostapd ( 2058): WPS: Building WPS IE for (Re)Association Response
D/hostapd ( 2058): WPS:  * Version (hardcoded 0x10)
D/hostapd ( 2058): WPS:  * Response Type (3)
D/hostapd ( 2058): WPS:  * Version2 (0x20)
D/hostapd ( 2058): nl80211: Set beacon (beacon_set=0)
D/hostapd ( 2058): WPA: Start group state machine to set initial keys
D/hostapd ( 2058): WPA: group state machine entering state GTK_INIT (VLAN-ID 0)
D/hostapd ( 2058): GTK - hexdump(len=16): [REMOVED]
D/hostapd ( 2058): WPA: group state machine entering state SETKEYSDONE (VLAN-ID 0)
D/hostapd ( 2058): wpa_driver_nl80211_set_key: ifindex=6 alg=3 addr=0x4006f0f1 key_idx=1 set_tx=1 seq_len=0 key_len=16
D/hostapd ( 2058):    broadcast key
D/hostapd ( 2058): nl80211: set_key failed; err=-2 No such file or directory)
D/hostapd ( 2058): wpa_driver_nl80211_set_operstate: operstate 0-&gt;1 (UP)
</pre>
</div>
</div>
<div id="outline-container-sec-12-2" class="outline-3">
<h3 id="sec-12-2">问题分析</h3>
<div class="outline-text-3" id="text-12-2">
<p>
因为Secure Key会通过 "/dev/random"去对Kernel做存储，SoftAp会透过这
种方法去储存和产生所有的Key Number。
</p>

<p>
hostapd去产生一个随机的dummy key时，产生错误，所以在调用 set key时
自然会失败。
</p>
</div>
</div>

<div id="outline-container-sec-12-3" class="outline-3">
<h3 id="sec-12-3">问题解决</h3>
<div class="outline-text-3" id="text-12-3">
<p>
失败的原因与Kernel中的一个选项有关： <code>CONFIG_CRYPTO_ANSI_CPRNG</code> ，
打开该选项后，就不会有这个问题。
另外， 配置文件中，wpa应该设置为0或者不显示设置, 当wpa的值设置不正
确时，会出现下述错误。
</p>
<div class="org-src-container">

<pre class="src src-sh">interface=wlan0 
driver=nl80211 
ssid=woody_hostap
hw_mode=g 
channel=6 
ieee80211n=1
#wpa=0
wpa_passphrase=12345678
wpa_key_mgmt=WPA-PSK 
wpa_pairwise=TKIP CCMP
wpa_ptk_rekey=600
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13">案例13 TV连接不上Hidden SSID AP</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1">问题描述</h3>
<div class="outline-text-3" id="text-13-1">
<p>
TP-LINK路由器将2.4G设置为Hidden, MT7662T连接2.4G不成功；将5G设置为Hidden却可以连接成功
</p>
</div>
</div>

<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2">问题分析</h3>
<div class="outline-text-3" id="text-13-2">
<p>
使用手机连接2.4G Hidden AP, 每次都能成功，可以比对TV与手机两者间的
Probe request frame有何差异.
</p>

<p>
环境：
</p>
<ul class="org-ul">
<li>TP-LINK双频路由一台，MS938+MT7662T开发板一块，红米3S手机一台
</li>
<li>MAC地址

<p>
TPLINK路由器:     8C:21:0A:F3:D5:72
</p>

<p>
MT7662 MAC:       00:6C:FD:AB:68:E2
</p>

<p>
红米3S手机：    74:23:44:82:5A:63
</p>
</li>
</ul>


<p>
Sniffer Log分析情况：
</p>

<ol class="org-ol">
<li>AP一直没回复probe response给TV。
</li>
<li>但是与手机连接时，却正常回复了probe response。
</li>
<li>对比TV和SP连接的probe request frame
发现TV多了HT CAP/WPS/P2P IE,  查看AP是能支持 11n的，
猜测比较可能出现不兼容 的是WPS IE


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016090201.png" class="img-responsive" alt="2016090201.png">
</p>
<figcaption><span class="figure-number">Figure 19:</span> TV连接失败的log</figcaption>
</figure>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016090202.png" class="img-responsive" alt="2016090202.png">
</p>
<figcaption><span class="figure-number">Figure 20:</span> SP连接成功的log</figcaption>
</figure>
</li>
<li>去掉WPS IE后进行测试
测试结果表明AP不接收TV发的WPS IE，属兼容性问题
</li>
<li>AP为何不能接收TV的WPS IE
现场有找到 一台使用MT7601的TV，发现是可以正常连接的, 对比了
MT7662T的WPS IE, 发现RF Bands的值有所不一样


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016090203.png" class="img-responsive" alt="2016090203.png">
</p>
<figcaption><span class="figure-number">Figure 21:</span> MT7601</figcaption>
</figure>


<figure>
<p><img src="http://blog.ifjy.me/images/2016/2016090204.png" class="img-responsive" alt="2016090204.png">
</p>
<figcaption><span class="figure-number">Figure 22:</span> MT7662T</figcaption>
</figure>
</li>
<li>修改RF Bands测试
修改MT7662T Probe request WPS IE的RF Bands 值为1进行测试，发现
每次都能连接成功

<p>
MT7662T是支持2.4/5G的，因此不建议将RF Bands设置为1.
</p>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3">问题解决</h3>
<div class="outline-text-3" id="text-13-3">
<p>
参考SP，station 在AP scan时Probe request不把WPS IE包进去
</p>

<p>
Probe request是否要带WPS IE, 需要看下面API的返回值
<img src="http://blog.ifjy.me/images/2016/2016090205.png" class="img-responsive" alt="2016090205.png">
</p>

<p>
默认情况下，发送Probe Request的时候不把WPS IE包含进来，但是当进行
Miracast/P2P连接时，动态打开限制，把WPS IE包含进来。这个逻辑通过上
层传递一个参数进来即可。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14">案例14 手机与TV进行Miracast连接，TCP连接失败</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1">问题描述</h3>
<div class="outline-text-3" id="text-14-1">
<p>
开机后，连接AP，然后使用WFD投屏, 投屏失败，退出WFD。
</p>
</div>
</div>

<div id="outline-container-sec-14-2" class="outline-3">
<h3 id="sec-14-2">问题分析</h3>
<div class="outline-text-3" id="text-14-2">
<ol class="org-ol">
<li>程序日志分析
查看连接过程中的日志，发现：
<pre class="example">
P2P-GROUP-STARTED p2p1 client ssid="DIRECT-uc-minote" 
</pre>
<p>
这个日志出现说明p2p连接是成功的，问题可能出现在后面。
</p>

<p>
继续后面，有看到dhcp交互过程也正常，TV有请求到IP地址，这说明问
题出现在RTSP交互阶段。
</p>
<pre class="example">
Lease of 192.168.49.30 obtained, lease time 3600
</pre>

<p>
在RTSP会话建立时，TV要通过TCP协议连接到7236这个端口上，但是连接
失败：
</p>
<pre class="example">
WfdRtspClient::buildTcpConnection tcp connect failed
</pre>
</li>

<li>tcpdump日志分析
TCP连接涉及三步握手过程，通过tcpdump可以分析一下这个过程是否成
功。
<img src="http://blog.ifjy.me/images/2016/2016120801.png" class="img-responsive" alt="2016120801.png">

<p>
TV这边一直在重传三步握手中的第一包数据SYN。是TV没有将数据传出去
还是手机一直没有回应？
</p>
</li>

<li>Sniffer日志分析
Sniffer日志可以查看最终从硬件发出去的数据。 通过抓取WiFi
Sniffer日志，发现并没有看到TV发出来的第一包握手包数据。看来是TV
这端的问题。接下来要确认问题是出现在驱动还是FW：
  打印从驱动向FW送数据前的日志，确认驱动有将数据往FW送。
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-14-3" class="outline-3">
<h3 id="sec-14-3">问题解决</h3>
<div class="outline-text-3" id="text-14-3">
<p>
最终确认问题发生在FW这边，FW没有将数据送出去。更新FW后，问题解决。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15">案例15 WPA: 4-Way Handshake failed， PSK may be incorrect</h2>
<div class="outline-text-2" id="text-15">
</div><div id="outline-container-sec-15-1" class="outline-3">
<h3 id="sec-15-1">问题描述</h3>
<div class="outline-text-3" id="text-15-1">
<p>
当通过 <code>wpa_supplicant</code> 跟某个AP进行连接时，出现4步握手错误，不断
重复打印日志
如下：
</p>
<div class="org-src-container">

<pre class="src src-sh">...
State: DISCONNECTED -&gt; SCANNING
Starting AP scan (broadcast SSID)
Scan requested (ret=0) - scan timeout 30 seconds
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8b19 len=8
Received 3891 bytes of scan results (9 BSSes)
CTRL-EVENT-SCAN-RESULTS 
Selecting BSS from priority group 0
Try to find WPA-enabled AP
0: 00:27:19:fd:ca:94 ssid='XXXXXXXX' wpa_ie_len=0 rsn_ie_len=20 caps=0x11
   skip - SSID mismatch
   skip - SSID mismatch
   skip - SSID mismatch
   selected based on RSN IE
   selected WPA AP 00:27:19:fd:ca:94 ssid='XXXXXXXX'
Trying to associate with 00:27:19:fd:ca:94 (SSID='XXXXXXXX' freq=2412 MHz)
Cancelling scan request
WPA: clearing own WPA/RSN IE
Automatic auth_alg selection: 0x1
RSN: using IEEE 802.11i/D9.0
WPA: Selected cipher suites: group 16 pairwise 16 key_mgmt 2 proto 2
WPA: clearing AP WPA IE
WPA: set AP RSN IE - hexdump(len=22): 30 14 01 00 00 0f ac 04 01 00 00 0f ac 04 01 00 00 0f ac 02 01 00
WPA: using GTK CCMP
WPA: using PTK CCMP
WPA: using KEY_MGMT WPA-PSK
WPA: Set own WPA IE default - hexdump(len=22): 30 14 01 00 00 0f ac 04 01 00 00 0f ac 04 01 00 00 0f ac 02 00 00
No keys have been configured - skip key clearing
wpa_driver_wext_set_drop_unencrypted
State: SCANNING -&gt; ASSOCIATING
wpa_driver_wext_set_operstate: operstate 0-&gt;0 (DORMANT)
WEXT: Operstate: linkmode=-1, operstate=5
wpa_driver_wext_associate
wpa_driver_wext_set_psk
Setting authentication timeout: 10 sec 0 usec
EAPOL: External notification - EAP success=0
EAPOL: External notification - EAP fail=0
EAPOL: External notification - portControl=Auto
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8b06 len=8
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8b04 len=12
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8b1a len=16
RTM_NEWLINK: operstate=0 ifi_flags=0x11003 ([UP][LOWER_UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
RTM_NEWLINK: operstate=0 ifi_flags=0x11003 ([UP][LOWER_UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8c08 len=24
AssocResp IE wireless event - hexdump(len=16): 01 08 82 84 8b 96 0c 18 30 48 32 04 12 24 60 6c
RTM_NEWLINK: operstate=0 ifi_flags=0x11003 ([UP][LOWER_UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8b15 len=20
Wireless event: new AP: 00:27:19:fd:ca:94
Association info event
resp_ies - hexdump(len=16): 01 08 82 84 8b 96 0c 18 30 48 32 04 12 24 60 6c
State: ASSOCIATING -&gt; ASSOCIATED
wpa_driver_wext_set_operstate: operstate 0-&gt;0 (DORMANT)
WEXT: Operstate: linkmode=-1, operstate=5
Associated to a new BSS: BSSID=00:27:19:fd:ca:94
No keys have been configured - skip key clearing
Associated with 00:27:19:fd:ca:94
WPA: Association event - clear replay counter
WPA: Clear old PTK
EAPOL: External notification - portEnabled=0
EAPOL: External notification - portValid=0
EAPOL: External notification - EAP success=0
EAPOL: External notification - portEnabled=1
EAPOL: SUPP_PAE entering state CONNECTING
EAPOL: SUPP_BE entering state IDLE
Setting authentication timeout: 10 sec 0 usec
Cancelling scan request
RX EAPOL from 00:27:19:fd:ca:94
Setting authentication timeout: 10 sec 0 usec
IEEE 802.1X RX: version=1 type=3 length=95
  EAPOL-Key type=2
  key_info 0x8a (ver=2 keyidx=0 rsvd=0 Pairwise Ack)
  key_length=16 key_data_length=0
  replay_counter - hexdump(len=8): 00 00 00 00 00 00 00 01
  key_nonce - hexdump(len=32): af a0 0b 03 51 8b 24 56 a1 2b 35 21 8f 94 94 85 27 26 76 33 6c 7e b0 cf 2f 14 19 
  key_iv - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  key_rsc - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_id (reserved) - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_mic - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
State: ASSOCIATED -&gt; 4WAY_HANDSHAKE
WPA: RX message 1 of 4-Way Handshake from 00:27:19:fd:ca:94 (ver=2)
RSN: msg 1/4 key data - hexdump(len=0):
WPA: Renewed SNonce - hexdump(len=32): 6d e5 7b a9 a6 3a 7e 8e b7 c8 a2 40 d1 f1 9c 6e 76 73 50 ec e1 77 84 38 0
WPA: PTK derivation - A1=00:80:48:3d:5d:60 A2=00:27:19:fd:ca:94
WPA: PMK - hexdump(len=32): [REMOVED]
WPA: PTK - hexdump(len=64): [REMOVED]
WPA: WPA IE for msg 2/4 - hexdump(len=22): 30 14 01 00 00 0f ac 04 01 00 00 0f ac 04 01 00 00 0f ac 02 00 00
WPA: Sending EAPOL-Key 2/4
RX EAPOL from 00:27:19:fd:ca:94
IEEE 802.1X RX: version=1 type=3 length=95
  EAPOL-Key type=2
  key_info 0x8a (ver=2 keyidx=0 rsvd=0 Pairwise Ack)
  key_length=16 key_data_length=0
  replay_counter - hexdump(len=8): 00 00 00 00 00 00 00 02
  key_nonce - hexdump(len=32): af a0 0b 03 51 8b 24 56 a1 2b 35 21 8f 94 94 85 27 26 76 33 6c 7e b0 cf 2f 14 19 
  key_iv - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  key_rsc - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_id (reserved) - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_mic - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
State: 4WAY_HANDSHAKE -&gt; 4WAY_HANDSHAKE
WPA: RX message 1 of 4-Way Handshake from 00:27:19:fd:ca:94 (ver=2)
RSN: msg 1/4 key data - hexdump(len=0):
WPA: PTK derivation - A1=00:80:48:3d:5d:60 A2=00:27:19:fd:ca:94
WPA: PMK - hexdump(len=32): [REMOVED]
WPA: PTK - hexdump(len=64): [REMOVED]
WPA: WPA IE for msg 2/4 - hexdump(len=22): 30 14 01 00 00 0f ac 04 01 00 00 0f ac 04 01 00 00 0f ac 02 00 00
WPA: Sending EAPOL-Key 2/4
RX EAPOL from 00:27:19:fd:ca:94
IEEE 802.1X RX: version=1 type=3 length=95
  EAPOL-Key type=2
  key_info 0x8a (ver=2 keyidx=0 rsvd=0 Pairwise Ack)
  key_length=16 key_data_length=0
  replay_counter - hexdump(len=8): 00 00 00 00 00 00 00 03
  key_nonce - hexdump(len=32): af a0 0b 03 51 8b 24 56 a1 2b 35 21 8f 94 94 85 27 26 76 33 6c 7e b0 cf 2f 14 19 
  key_iv - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  key_rsc - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_id (reserved) - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_mic - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
State: 4WAY_HANDSHAKE -&gt; 4WAY_HANDSHAKE
WPA: RX message 1 of 4-Way Handshake from 00:27:19:fd:ca:94 (ver=2)
RSN: msg 1/4 key data - hexdump(len=0):
WPA: PTK derivation - A1=00:80:48:3d:5d:60 A2=00:27:19:fd:ca:94
WPA: PMK - hexdump(len=32): [REMOVED]
WPA: PTK - hexdump(len=64): [REMOVED]
WPA: WPA IE for msg 2/4 - hexdump(len=22): 30 14 01 00 00 0f ac 04 01 00 00 0f ac 04 01 00 00 0f ac 02 00 00
WPA: Sending EAPOL-Key 2/4
EAPOL: startWhen --&gt; 0
EAPOL: disable timer tick
EAPOL: SUPP_PAE entering state CONNECTING
EAPOL: enable timer tick
EAPOL: txStart
WPA: drop TX EAPOL in non-IEEE 802.1X mode (type=1 len=0)
RX EAPOL from 00:27:19:fd:ca:94
IEEE 802.1X RX: version=1 type=3 length=95
  EAPOL-Key type=2
  key_info 0x8a (ver=2 keyidx=0 rsvd=0 Pairwise Ack)
  key_length=16 key_data_length=0
  replay_counter - hexdump(len=8): 00 00 00 00 00 00 00 04
  key_nonce - hexdump(len=32): af a0 0b 03 51 8b 24 56 a1 2b 35 21 8f 94 94 85 27 26 76 33 6c 7e b0 cf 2f 14 19 
  key_iv - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  key_rsc - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_id (reserved) - hexdump(len=8): 00 00 00 00 00 00 00 00
  key_mic - hexdump(len=16): 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
State: 4WAY_HANDSHAKE -&gt; 4WAY_HANDSHAKE
WPA: RX message 1 of 4-Way Handshake from 00:27:19:fd:ca:94 (ver=2)
RSN: msg 1/4 key data - hexdump(len=0):
WPA: PTK derivation - A1=00:80:48:3d:5d:60 A2=00:27:19:fd:ca:94
WPA: PMK - hexdump(len=32): [REMOVED]
WPA: PTK - hexdump(len=64): [REMOVED]
WPA: WPA IE for msg 2/4 - hexdump(len=22): 30 14 01 00 00 0f ac 04 01 00 00 0f ac 04 01 00 00 0f ac 02 00 00
WPA: Sending EAPOL-Key 2/4
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
Wireless event: cmd=0x8b15 len=20
Wireless event: new AP: 00:00:00:00:00:00
WPA: 4-Way Handshake failed - pre-shared key may be incorrect
Setting scan request: 0 sec 100000 usec
BSSID 00:27:19:fd:ca:94 blacklist count incremented to 2
CTRL-EVENT-DISCONNECTED - Disconnect event - remove keys
wpa_driver_wext_set_key: alg=0 key_idx=0 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=1 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=2 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=3 set_tx=0 seq_len=0 key_len=0
wpa_driver_wext_set_key: alg=0 key_idx=0 set_tx=0 seq_len=0 key_len=0
State: 4WAY_HANDSHAKE -&gt; DISCONNECTED
...

... and again from the top.
</pre>
</div>

<p>
一直报： "WPA: 4-Way Handshake failed - pre-shared key may be
incorrect"
</p>
</div>
</div>

<div id="outline-container-sec-15-2" class="outline-3">
<h3 id="sec-15-2">问题分析</h3>
<div class="outline-text-3" id="text-15-2">
<p>
从日志的字面上理解，可能是我们提供的密码有错。但是，再三确认过，输
入的密码是正确的。
</p>

<p>
<code>wpa_supplicant</code> 的网络配置如下：
</p>
<div class="org-src-container">

<pre class="src src-sh">$ wpa_passphrase "test" "passphrase"
network={
        ssid="test"
        #psk="passphrase"
        psk=a8f6fbf02bfbd7ddd27249ac101487ff51c245b2c34c2efe46b6e680b367ee32
}
</pre>
</div>

<p>
<b>Note</b> 
</p>

<p>
但 <code>psk</code> 使用明文表示时，则 <code>wpa_supplicant</code> 在第一次读取配置文件
时，会实时生成一个 256-bit 的十六进制的 <code>psk</code> 。当然我们也可以通过
<code>wpa_passphrase</code> 程序提供生成 256-bit 的十六进制的 <code>psk</code> ，直接写
在配置文件中。
</p>

<p>
遇到日志报密码不正确的问题时，有如下几个Check点：
</p>
<ol class="org-ol">
<li>换一种 <code>psk</code> 的写法，交叉对比测试一下。
</li>
<li>检查 <code>psk</code> 是否有特殊字符存在。
</li>
<li>通过Sniffer Log看下是否底层传递数据的问题。
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-15-3" class="outline-3">
<h3 id="sec-15-3">问题解决</h3>
<div class="outline-text-3" id="text-15-3">
<p>
当使用明文的方式 配置 psk 的时候，连接就正常了。
</p>
</div>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">案例1 Miracast无法连接</a>
<ul class="nav">
<li><a href="#sec-1-1">问题描述</a></li>
<li><a href="#sec-1-2">问题分析</a></li>
<li><a href="#sec-1-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-2">案例2 p2p虚拟网络接口打开时，出现设备忙</a>
<ul class="nav">
<li><a href="#sec-2-1">问题描述</a></li>
<li><a href="#sec-2-2">问题分析</a></li>
<li><a href="#sec-2-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-3">案例3 在某个特定区域WiFi性能很差</a>
<ul class="nav">
<li><a href="#sec-3-1">问题描述</a></li>
<li><a href="#sec-3-2">问题分析</a></li>
<li><a href="#sec-3-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-4">案例4 固件升级后，手机出现奇怪现象</a>
<ul class="nav">
<li><a href="#sec-4-1">问题描述</a></li>
<li><a href="#sec-4-2">问题分析</a></li>
<li><a href="#sec-4-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-5">案例5 WiFi性能差，且有时连接不上WiFi网络</a>
<ul class="nav">
<li><a href="#sec-5-1">问题描述</a></li>
<li><a href="#sec-5-2">问题分析</a></li>
<li><a href="#sec-5-3">问题解决</a></li>
</ul>
</li>
<li><a href="#sec-6">案例6 客户报怨传输高分辨率的图片时很慢</a>
<ul class="nav">
<li><a href="#sec-6-1">问题描述</a></li>
<li><a href="#sec-6-2">问题分析</a></li>
<li><a href="#sec-6-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-7">案例7 连接老旧AP热点失败</a>
<ul class="nav">
<li><a href="#sec-7-1">问题描述</a></li>
<li><a href="#sec-7-2">问题分析</a></li>
<li><a href="#sec-7-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-8">案例8 A模下吞吐量偏低的问题</a>
<ul class="nav">
<li><a href="#sec-8-1">问题描述</a></li>
<li><a href="#sec-8-2">问题分析</a></li>
<li><a href="#sec-8-3">解决方法</a></li>
</ul>
</li>
<li><a href="#sec-9">案例9 p2p go失败后，导致wlan断开</a>
<ul class="nav">
<li><a href="#sec-9-1">问题描述</a></li>
<li><a href="#sec-9-2">问题分析</a></li>
<li><a href="#sec-9-3">解决方案</a></li>
</ul>
</li>
<li><a href="#sec-10">案例10 Miracast过程中，视频卡住</a>
<ul class="nav">
<li><a href="#sec-10-1">问题描述</a></li>
<li><a href="#sec-10-2">问题分析</a>
<ul class="nav">
<li><a href="#sec-10-2-1">现象梳理</a></li>
<li><a href="#sec-10-2-2">问题根源</a></li>
</ul>
</li>
<li><a href="#sec-10-3">问题解决</a></li>
</ul>
</li>
<li><a href="#sec-11">案例11 TCP RX enhancement</a>
<ul class="nav">
<li><a href="#sec-11-1">问题描述</a></li>
<li><a href="#sec-11-2">问题分析</a></li>
<li><a href="#sec-11-3">问题解决</a></li>
</ul>
</li>
<li><a href="#sec-12">案例12 hostapd启动时报错: nl80211: set<sub>key</sub> failed</a>
<ul class="nav">
<li><a href="#sec-12-1">问题描述</a></li>
<li><a href="#sec-12-2">问题分析</a></li>
<li><a href="#sec-12-3">问题解决</a></li>
</ul>
</li>
<li><a href="#sec-13">案例13 TV连接不上Hidden SSID AP</a>
<ul class="nav">
<li><a href="#sec-13-1">问题描述</a></li>
<li><a href="#sec-13-2">问题分析</a></li>
<li><a href="#sec-13-3">问题解决</a></li>
</ul>
</li>
<li><a href="#sec-14">案例14 手机与TV进行Miracast连接，TCP连接失败</a>
<ul class="nav">
<li><a href="#sec-14-1">问题描述</a></li>
<li><a href="#sec-14-2">问题分析</a></li>
<li><a href="#sec-14-3">问题解决</a></li>
</ul>
</li>
<li><a href="#sec-15">案例15 WPA: 4-Way Handshake failed， PSK may be incorrect</a>
<ul class="nav">
<li><a href="#sec-15-1">问题描述</a></li>
<li><a href="#sec-15-2">问题分析</a></li>
<li><a href="#sec-15-3">问题解决</a></li>
</ul>
</li>
</ul>
</div>
</nav>
</div></div></div>
