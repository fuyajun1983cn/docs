#+TITLE: Hands Free Profile要点记录


* Overview
  Hands-Free Profile describes how a an audio gateway device can be
  used to place and receive calls for a hand-free device. 

  A  common  scenario  would  be  a mobile  phone  used  together
  with  a  wireless  headset.  The headset  will connect to the mobile
  phone and can be used to place and receive phone calls. The HFP
  defines two roles, that of an Audio Gateway (HFP-AG) and a
  Hands-Free unit (HF): 
  - HFP Audio Gateway (HFP-AG) is the device that is the gateway of
    the audio, both for input and output, typically a mobile phone.
  - Hands-Free Unit (HF) is the device acting as the Audio Gateway’s
    remote audio input and output mechanism. It also provides some
    remote control means. Typically a wireless headset or a car kit. 


  Hands-Free control is the entity responsible for Hands-Free unit
  specific control signalling; this signalling is AT command
  based. Control channel works on top of RFCOMM connection and the audio
  channel on top of SCO or eSCO channel.

  Hands-Free profile v.1.5 and older support 8kHz, 8-bit audio and
  Hands-Free profile v.1.6 support 16kHz and 8-bit audio also known as
  Wide Band Speech or HD Voice. 

  #+CAPTION: Typical HFP use case
  [[./images/02.png]]

** Connection establishment
   
*** HFP control channel
    With Hands-Free Profile, first a control channel needs to be first
    established. The control channel is used for AT command signalling
    between the HF and HFP-AG devices.

*** HFP audio channel
    Once the HFP control channel has been set up an audio channel can
    be created. There are several ways how the audio channel can be
    established depending on the use case. 
    1. HFP-AG receives an incoming phone call
       A typical scenario is that the HFP-AG device (f.ex. a mobile
       phone) receives an incoming phone call and indicates this to
       the HF device. HF device then accepts or rejects the incoming
       call.
    2. HF device makes an outgoing call request
       On the HF device outgoing connection can be established with
       two different commands: 
       - “ATD{number};”
         Asks HFP-AG to dial to /number/.
       - “AT+BLDN”
         Asks HFP-AG to dial to last dialled number.
    3. HFP-AG makes an outgoing call
    4. HFP-AG indicates an incoming phone call to a HFP device.
       On the HFP-AG device RING command is used to indicate an
       incoming phone call to the HF device.
    5. HFP-AG receives an outgoing phone call request from HFP
    6. Forcing SCO connection open
       With HFP 1.6 version codec negotiation prevents the possibility
       of forcing the connection open like it was possible in HFP 1.5.

       In case both ends support codec negotiation in HFP 1.6 the SCO
       connection must be opened by the HFP-AG.

** Three way calling (HF only)
   Three way calling enables the HF user to put calls on hold and join
   calls into multiparty “conference” calls, if the AG supports these
   features. If the AG supports three way calling, only the “hold”
   state is mandatory to support. 

   issue AT+CCWA=1 to AG to enable three way calling. 

*** Using AT+CHLD
    Once three-way calling is set up, the HF will receive
    notifications of incoming calls when a call is already
    active. Upon receiving a CCWA notification, the user can use
    AT+CHLD=<n> to control the calls: 

    #+CAPTION: Supported AT+CHLD commands
    | Command    | Function                                                                               |
    |------------+----------------------------------------------------------------------------------------|
    | AT+CHLD=0  | Release all held calls, reject waiting calls with “User busy”                          |
    | AT+CHLD=1  | Release all active calls, accept held or waiting call                                  |
    | AT+CHLD=1x | As above, but release only the call whose idx is x                                     |
    | AT+CHLD=2  | Put all active calls on hold, accept held or waiting call                              |
    | AT+CHLD=2x | Put all calls on hold, except for the one whose idx is x (“private consultation mode”) |
    | AT+CHLD=3  | Add a held call to the current conversation (“multiparty” / “conference” call)         |
    | AT+CHLD=4  | Connect active and held call, disconnect user from the call (“explicit call transfer”) |
    |------------+----------------------------------------------------------------------------------------|

** Available AT-commands with Hands-Free Profile
   The AT commands and indications that are available for the
   Bluetooth Hands-Free profile are listed below.
   - ATA
     Standard call answer AT command.
   - ATDdd…dd;
     Standard AT command intended for placing a call to a phone
     number. Only voice calls are covered in this specification.
   - ATD>nnn...;
     Extension of the standard ATD command, intended for memory
     dialing. Only voice calls are covered in this specification.
   - AT+CCWA
     Standard “Call Waiting notification” AT command. Within the
     AT+CCWA=[<n>[,<mode>[,<class>]]]command, only enabling/disabling
     of the Call Waiting notification unsolicited result code +CCWA ,
     using the <n> parameter, is covered in this specification.
   - AT+CHLD
     Standard call hold and multiparty handling AT command.
   - AT+CHUP
     Standard hang-up AT command. Execution command causes the AG to
     terminate the currently active call. This command shall have no
     impact on the state of any held call.
   - AT+CIND
     Standard indicator update AT command.
   - +CIND
     Standard list of current phone indicators.
   - AT+CLCC
     Standard list current calls command.
   - +CLCC
     Standard list current calls result code
   - AT+COPS
     The AT+COPS=3,0 shall be sent by the HF to the AG prior to
     sending the AT+COPS? command.AT+COPS=3,0 sets the format of the
     network operator string to the long format alphanumeric.
   - AT+CMEE
     Standard AT command used to enable the use of result code.
   - AT+CLIP
     Standard “Calling Line Identification notification” activation AT
     command. It enables/disables the Calling Line Identification
     notification unsolicited result code +CLIP.
   - +CLIP
     Standard “Calling Line Identification notification” unsolicited result code.
   - AT+CMER
     Standard event reporting activation/deactivation AT command.
   - +CIEV
     Standard “indicator events reporting” unsolicited result code.
   - AT+VTS
     Standard DTMF generation AT command. Only the AT+VTS=<DTMF>
     command format is covered in this specification.
   - AT+CNUM
     AT+CNUM (Retrieve Subscriber Number Information)
   - +CNUM
     Standard Response used for sending the “Subscriber Number Information” from AG to HF.
   - AT+BIA
     Bluetooth Indicators Activation. Command used by HF to activate /
     deactivate individual indicators.
   - AT+BINP
     Command used for requesting some specific data input from the
     AG4. On reception of this command the AG shall perform the proper
     actions such that the requested information is sent back to the
     HF using the +BINP response.
   - AT+BINP
     Command used for requesting some specific data input from the
     AG4. On reception of this command the AG shall perform the proper
     actions such that the requested information is sent back to the
     HF using the +BINP response.
   - AT+BLDN
     Bluetooth Last Dialed Number
   - AT+BVRA
     Bluetooth Voice Recognition Activation
   - +BVRA
     Bluetooth Voice Recognition Activation. Unsolicited result code
     used to notify the HF when the voice recognition function in the
     AG is activated/deactivated autonomously from the AG.
   - AT+BRSF
     (Bluetooth Retrieve Supported Features. Notifies the AG of the
     supported features available in the HF, and requests information
     about the supported features in the AG. The supported features
     shall be represented as a decimal value.
   - +BRSF
     Bluetooth Retrieve Supported Features).Result code sent by the AG
     in response to the AT+BRSF command, used to notify the HF what
     features are supported in the AG. The supported features shall be
     represented as a decimal value.
   - AT+NREC (Noise Reduction and Echo Canceling)
     Command issued to disable any Echo Canceling and Noise Reduction
     functions embedded in the AG. Only support for execution command
     is mandated. Neither the read nor test commands are mandatory.
   - AT+VGM
     Gain of Microphone. Command issued by the HF to report its
     current microphone gain level setting to the AG. <gain> is a
     decimal numeric constant, relating to a particular
     (implementation dependent) volume level controlled by the
     HF. This command does not change the microphone gain of the AG;
     it simply indicates the current value of the microphone gain in
     the HF.
   - AT+VGS (Gain of Speaker)
     Command issued by the HF to report its current speaker gain level
     setting to the AG. <gain> is a decimal numeric constant, relating
     to a particular (implementation dependent) volume level
     controlled by the HF. This command does not change the speaker
     gain of the AG; it simply indicates the current value of the
     speaker volume in the HF.
   - +VGM (Gain of Microphone)
     Unsolicited result code issued by the AG to set the microphone
     gain of the HF. <gain> is a decimal numeric constant, relating to
     a particular (implementation dependent) volume level controlled
     by the HF.
   - +VGS (Gain of Speaker)
     Unsolicited result code issued by the AG to set the speaker gain
     of the HF. <gain> is a decimal numeric constant, relating to a
     particular (implementation dependent) volume level controlled by
     the HF.
   - ++BSIR (Bluetooth Setting of In-band Ring tone)
     Unsolicited result code issued by the AG to indicate to the HF
     that the in-band ring tone setting has been locally changed. The
     HF may react accordingly by changing its own alert method.
   - AT+BTRH (Bluetooth Response and Hold Feature)
     Command issued by the HF for the “Response and Hold” feature in
     the AG. This specification defines the use of the set and read
     command. The AT+BTRH? command shall be used by the HF to query
     the current “Response and Hold” state of the AG.
   - +BTRH (Bluetooth Response and Hold Feature)
     Result code used to notify the HF when-ever the incoming call is
     either put on hold or accepted or rejected. The AG shall also
     respond back with this response for the AT+BTRH? command from the
     HF.

*** Phonebook specific AT commands
    - AT+CPBS=?
      Lists the phonebooks that the phone contains. (Choose phonebook
      storage) 

      Returns: +CPBS:
      ("ME","SM","MT","ON","DC","MC","RC","EN","AD","QD","SD","FD")
      
      +CPBS="ME" sets the "retrieve mode" to the internal phonebook.

      +CPBS="SM" sets the "retrieve mode" to the SIM phonebook.

    - AT+CPBR=?
      Describes the phonebook selected above. (Simple) This gives the
      max number of entries the phone can contain. It also gives the
      maximum phone number (or email address) length and name length. 

      NOTE: You can substitute +MPBR for any +CPBR command, but the
      phone returns a much more specific (and less intelligible)
      response containing more fields that may act as internal
      “programming” flags of some sort. 

      Returns: +CPBR: (1-1000),40,24

    - AT+CPBR=[beginning index],[ending index]
      Returns a list of numbers with the index between the two numbers
      entered. Also denotes what TYPE of phonebook entry was selected.

      Returns: +CPBR: 9,"18005555555",129,"Contact Name" – 129 refers
      to a phone number. 

      Returns: +CPBR: 18,"user@domain.net",128,"Contact Name" – 128
      refers to an email.

    - AT+CPBR=[index]
      Returns the specified index.

      Returns: +CPBR: 18,"user@domain.net",128,"Contact Name"

    - AT+MPBF="Name"
      Searches the phonebook for the Name or string.

    - AT+MPBR=?
      Similar to above, but a more verbose result is displayed.
      Returns: +MPBR:
      1-1000,40,24,8,0-1,50,(0,2,4,6,9-30,255),(0),(0-1),(1-30),(255),25,(0-1,255),264,(0),0,0,0,0,0,0,0

      - 1-1000 denotes the number of entries that can be stored on the selected (+CPBS) phonebook.

      - 40 represents the number of characters that the email or phone number can have.

      - 24 indicates the number of characters the “friendly” name can have.

      - The 8 refers to the different “types” of phonebook entry (i.e. Mobile, Main, Email, Home, Fax, Work …etc).

      - The +CPBR command does not list anything after the 24 (as seen
        above), so there are times when the +MPBR may be useful.

    - AT+MPBR=[index]
      Returns: +MPBR: 18,"user@domain.net",128,"Contact

      Name",6,0,255,0,0,1,255,255,0,"",0,0,"","","","","","","",""

**** SMS specific AT commands
     - AT+CMGF=1
       This tells the phone to display the entries as text rather than
       binary. +CMFG=0 would display the data in binary format.
     - AT+CPMS=?
       This displays all of the locations in which the phone can save
       the SMS messages. 

       Returns: +CPMS: ("MT","IM","OM","BM","DM"),("OM","DM"),("IM")
     - AT+CMGL=?
       Returns the options on which messages you wish to display.

       Returns: +CMGL: ("REC UNREAD", "REC READ", "STO UNSENT", "STO SENT", "ALL")
     - AT+CMGL="ALL"
       Selects and displays all of the SMS messages on the selected source.
     - AT#PMODE=1
       In order to retrieve text messages and other information, Samsung phones must be in this mode.
     - AT#PSRMR=?
       Returns the parameters to obtain text messages (Samsung).

       Returns: #PSRMR: (0-349)
     
       
* Feature & Procedure

** Connection management
   
*** Service Level Connection establishment
    either the AG or HF may initiate a Service Level Connection
    establishment procedure. 

    before that, a RFCOMM data link channel between the HF and the AG
    should exist between them. 

    either the AG or HF may initiate a RFCOMM connection
    establishment.

    after a RFCOMM connection establishment performed, the Service
    Level Connection Initialization Procedure should begin as follows:
    1. Supported features exchange
       HF send AT+BRSF=<HF supported features> command to AG to both notify
       the AG of the supported features in the HF and retrieve the
       supported features in the AG using the +BRSF result code.
    2. Codec Negotiation
       if the HF supports the Codec Negotiation feature, it shall
       check if the AT+BRSF command response from the AG has indicated
       that it supports the Codec Negotiation feature. 

       if both support Codec Negotiation feature, the HF shall send
       the AT+BAC=<HF available codecs> command to the AG to notify
       the AG of the available codecs in the HF.
    3. AG Indicators
       The HF uses the AT+CIND=? Test command to retrieve information
       about the supported indicators and their ordering. 
       
       Once the HF has the necessary supported indicator and ordering
       information, it shall retrieve the current status of the
       indicators in the AG using the AT+CIND? Read command. 

       After having retrieved the status of the indicators in the AG,
       the HF shall then enable the "Indicators status update"
       function in the AG by issuing the AT+CMER command, to which the
       AG shall respond with OK. 

       As a result, the AG shall send the +CIEV unsolicited result
       code with the corresponding indicator value whenever a change
       in service, call, or call setup status occurs. 

       When an update is required for both the call and call setup
       indicators, the AG shall send the +CIEV unsolicited result code
       for the call indicator before sending the +CIEV unsolicited
       result code for the call setup indicator. The HF shall use the
       information provided by the +CIEV code to update its own
       internal and/or external indications. 

       Once the "Indicators status update" function has been enabled,
       the AG shall keep the function enabled until either the AT+CMER
       command is issued to disable it, or the current Service Level
       Connection between the AG and the HF is dropped for any
       reason. 

       After the HF has enabled the “Indicators status update”
       function in the AG, and if the “Call waiting and 3-way calling”
       bit was set in the supported features bitmap by both the HF and
       the AG, the HF shall issue the AT+CHLD=? test command to
       retrieve the information about how the call hold and multiparty
       services are supported in the AG. The HF shall not issue the
       AT+CHLD=? test command in case either the HF or the AG does not
       support the "Three-way calling" feature.
    4. HF Indicators
       If the HF supports the HF indicator feature, it shall check the
       +BRSF response to see if the AG also supports the HF Indicator
       feature.

       If both the HF and AG support the HF Indicator feature, then
       the HF shall send the AT+BIND=<HF supported HF indicators>
       command to the AG to notify the AG of the supported indicators’
       assigned numbers in the HF. The AG shall respond with OK. 

       After having provided the AG with the HF indicators it
       supports, the HF shall send the AT+BIND=? to request HF
       indicators supported by the AG. The AG shall reply with the
       +BIND response listing all HF indicators that it supports
       followed by an OK. 

       Once the HF receives the supported HF indicators list from the
       AG, the HF shall send the AT+BIND? command to determine which
       HF indicators are enabled. The AG shall respond with one or
       more +BIND responses. The AG shall terminate the list with OK. 

       From this point onwards, the HF may send the AT+BIEV command
       with the corresponding HF indicator value whenever a change in
       value occurs of an enabled HF indicator. 

       The AG may enable or disable the notification of any HF
       indicator at any time by using the +BIND unsolicited response.
    5. End of Service Level Connection
       The HF shall consider the Service Level Connection fully
       initialized, and thereby established, in either of the
       following cases: 
       - After the HF has successfully retrieved information about HF
         indicators currently enabled by the AG using the AT+BIND?
         command, if and only if the “HF indicators” bit was set in
         the HF supported features bitmap and the AG supported
         features bitmap as exchanged via +BRSF command.

       - After the HF has successfully retrieved information about how
         call hold and multiparty services are supported in the AG
         using the AT+CHLD command, if and only if the “Call waiting
         and 3-way calling” bit was set in the SupportedFeatures
         attribute of the SDP records for both HF and AG. For this
         case to apply, the “HF Indicators” bit must not be set in the
         supported features bitmap for either the HF or the AG as
         exchanged via +BRSF command.

       - After the HF has successfully enabled the “Indicator status
         update” using the AT+CMER command. For this case to apply,
         the “Call waiting and 3-way calling” bit must not be set in
         the SupportedFeatures attribute of the SDP records for either
         the HF or the AG. Additionally, the “HF Indicators” bit must
         not be set in the supported features bitmap for either the HF
         or the AG as exchanged via +BRSF command.

       The AG shall consider the Service Level Connection to be fully
       initialized, and thereby established, in either of the following
       cases: 
       - After the AG has successfully responded with information
         about which HF indicators are enabled on the AG using +BIND
         as well as responded OK, if and only if the “HF Indicators”
         bit was set in the HF supported features bitmap and the AG
         supported features bitmap as exchanged via +BRSF command.
       - After that the AG has successfully responded with information
         about how call hold and multiparty services are supported in
         the AG using +CHLD as well as responded OK, if and only if
         the “Call waiting and 3-way calling” bit was set in the
         SupportedFeatures of the SDP attribute for both HF and
         AG. For this case to apply, the “HF Indicators” bit must not
         be set in the supported features bitmap for either the HF or
         the AG as exchanged via +BRSF command.
       - After the AG has successfully responded with OK to the
         AT+CMER command (to enable the “Indicator status update”
         function.) For this case to apply, the “Call waiting and
         3-way calling” bit must not be set in the supported features
         bitmap for either the HF or the AG. Additionally, the “HF
         Indicators” bit must not be set in the supported features
         bitmap for either the HF or the AG as exchanged via +BRSF
         command.

    6. Service Level Connection Diagram

       #+CAPTION: Service Level Connection establishment
       [[./images/01.png]]
    
*** Service Level Connection release

** Phone status information
   
*** Transfer of Registration Status

*** Transfer of Signal Strength Indication

*** Transfer of Roaming Status Indication

*** Transfer of Battery Level Indication

*** Query of Operator Selection

*** Extended Audio Gateway Error Codes

*** Transfer of Call, Call Setup and Call Held Status

** Audio Connection handling

*** Audio Connection set up

*** Audio Connection release

*** Codec Connection set up

** Accept an incoming voice call

*** Answer an incoming call

** Reject an incoming voice call

*** Reject an incoming call

** Terminate a call

*** Terminate a call process

** Audio Connection transfer during an ongoing call

*** Audio Connection transfer towards the HF

*** Audio Connection transfer towards the AG

** Place a call with the phone number supplied by the HF

*** Place a call with the phone number supplied by the HF

** Place a call using memory dialing

*** Memory dialing from the HF

** Place a call to the last number dialed

*** Last number re-dial from the HF

** Call waiting notification

*** Call waiting notification activation

** Three-way calling

*** Three-way call handling

** Calling Line Identification (CLI)

*** Calling Line Identification (CLI) notification

** Echo canceling (EC) and noise reduction (NR)

*** HF requests turning off the AG’s EC and NR

** Voice recognition activation

*** Voice recognition activation

** Attach a phone number to a voice tag

*** Attach a voice tag to a phone number

** Ability to transmit DTMF codes

*** Transmit DTMF code

** Remote audio volume control

*** Remote audio volume control

*** Volume level synchronization

** Response and Hold

*** Query response and hold status

*** Put an incoming call on hold from HF

*** Put an incoming call on hold from AG

*** Accept a held incoming call from HF

*** Accept a held incoming call from AG

*** Reject a held incoming call from HF

*** Reject a held incoming call from AG

*** Held incoming call terminated by caller

** Subscriber Number Information
   
*** Subscriber Number Information

** Enhanced Call Status

*** Query Call List

** Enhanced Call Control

*** Release Specified Call

*** Private Consult Mode

** Individual Indicator Activation

*** Indicators Activation and Deactivation

** Wide Band Speech

*** Wide Band Speech

** Codec Negotiation

*** Codec Negotiation

** HF Indicators

*** HF Indicators
